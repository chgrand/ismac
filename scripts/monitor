#!/usr/bin/env python

import rospy
import rosbag
from std_msgs.msg import Empty
from geometry_msgs.msg import PoseStamped
from metal.srv import AleaAction
import os, sys
import json
from PySide import QtGui
from map_viewer import MapViewer
import time
import logging

## Global properties

logger = logging.getLogger("ismac")
ch = logging.StreamHandler()
logger.addHandler(ch)
cf = logging.Formatter('[%(asctime)s][%(levelname)s] (%(name)s): %(message)s')
ch.setFormatter(cf)
logger.setLevel(logging.INFO)
logger.info("ismac started")

bag_record = False
bag = None

#------------------------------------------------------------------------------
class Agent:
    def __init__(self, name, color):
        self.name = name
        self.x = 0
        self.y = 0
        self.color = color    
        rospy.Subscriber("/"+name+"/pose", PoseStamped, self.callback)

    def set_gui(self, gui):
        self.gui = gui
            
    def callback(self, data):
        global bag_record, bag
        
        if bag_record:
            bag.write('/'+self.name+'/pose', data)
        self.x = data.pose.position.x
        self.y = data.pose.position.y
        try:
            self.gui.update()    
        except:
            None
        
    
    def get_pos(self):
        return (self.x, self.y)

    def get_name(self):
        return self.name

    def getColor(self):
        return self.color


#------------------------------------------------------------------------------
class MainWin(QtGui.QWidget):

    def __init__(self, map_viewer_):
        super(MainWin, self).__init__()
        self.hidden_start_pub = rospy.Publisher('/hidden/start', Empty, queue_size = 1)
        self.create_ui(map_viewer_)
        
    def cb_start_mission(self):
        self.hidden_start_pub.publish(Empty())
        logger.info("Start mission")
        
    def cb_log_poses(self):
        global bag, bag_record, mission_name
        if self.sender().isChecked():
            self.sender().setStyleSheet("background-color: red")
            self.sender().setText('Log pose ON')            
            bag_name = time.strftime('%Y-%m-%d-%H-%M-%S')+'_'+mission_name+'_poses.bag'
            bag = rosbag.Bag(bag_name, 'w')
            bag_record = True            
            logger.info("Start pose Log")
        else:
            self.sender().setStyleSheet("background-color: lightgrey")
            self.sender().setText('Log pose OFF')
            bag_record = False
            bag.close()
            logger.info("Stop pose Log")

    def send_alea(self, agent, alea, parameter):
        # rosservice to send alea to agent
        logger.info('Send alea : [%s , %s]' % (alea, parameter))
        serviceProxy = rospy.ServiceProxy('/'+agent+'/alea', AleaAction)
        resp = serviceProxy(alea, parameter)
        if resp.success:
            logger.info('[%s] alea service ACK ' % agent)
        else:
            logger.warning('[%s] alea service NOT ACK ' % agent)
        

    def cb_kill_robot(self):
        killed_agent = self.comboBoxKilled.currentText()
        informed_agent = self.comboBoxInformed.currentText()
        logger.info('Kill {0} and inform {1}'.format(killed_agent, informed_agent))
        self.send_alea(killed_agent, 'robotDead', '{"robot":"'+killed_agent+'"}')
        self.send_alea(informed_agent, 'robotDead', '{"robot":"'+killed_agent+'"}')

    def cb_STN_update(self):
        agent = self.comboBoxAgent.currentText()
        self.send_alea(agent, 'sendMastn', '{}')

    def cb_force_repair(self):
        agent = self.comboBoxAgent.currentText()
        self.send_alea(agent, 'repair', '{}')
        

    def add_agent(self, name):
        self.comboBoxKilled.addItem(name)
        self.comboBoxInformed.addItem(name)
        self.comboBoxAgent.addItem(name)
        
    def create_ui(self, map_viewer_):
        vbox = QtGui.QVBoxLayout()
        btn = QtGui.QPushButton("Start mission")
        btn.setMinimumHeight(32)
        btn.clicked.connect(self.cb_start_mission)
        vbox.addWidget(btn)
        
        btn = QtGui.QPushButton("Log poses OFF")
        btn.setMinimumHeight(32)
        btn.setCheckable(True)
        btn.toggled.connect(self.cb_log_poses)
        vbox.addWidget(btn)
        vbox.addSpacing(32)

        vbox.addWidget(QtGui.QLabel('Killed robot:'))
        self.comboBoxKilled = QtGui.QComboBox()
        vbox.addWidget(self.comboBoxKilled)
        vbox.addWidget(QtGui.QLabel('Informed robot:'))
        self.comboBoxInformed = QtGui.QComboBox()
        vbox.addWidget(self.comboBoxInformed)                
        
        btn = QtGui.QPushButton("Kill !!!")
        btn.setMinimumHeight(32)
        btn.clicked.connect(self.cb_kill_robot)
        vbox.addWidget(btn)
        vbox.addSpacing(32)

        vbox.addWidget(QtGui.QLabel('Action on agent:'))
        self.comboBoxAgent = QtGui.QComboBox()
        vbox.addWidget(self.comboBoxAgent)                
        
        btn = QtGui.QPushButton("STN update")
        btn.clicked.connect(self.cb_STN_update)
        vbox.addWidget(btn)

        btn = QtGui.QPushButton("Force repair")
        btn.clicked.connect(self.cb_force_repair)
        vbox.addWidget(btn)

        #btn = QtGui.QPushButton("Target found")
        #btn.clicked.connect(self.cb_kill_robot)
        #vbox.addWidget(btn)

        vbox.addStretch(1)
        
        group = QtGui.QGroupBox()
        group.setFixedWidth(180)
        group.setLayout(vbox)


        
        hbox = QtGui.QHBoxLayout()
        hbox.addWidget(map_viewer_)
        hbox.addWidget(group)

        self.setLayout(hbox)
        self.setGeometry(500, 400, 900, 600) #int(y_size*500/x_size))
        self.setWindowTitle('ISMAC')
        self.show()


#------------------------------------------------------------------------------
def main():
    global mission_name
    
    if len(sys.argv) < 2:
        print("usage: {0} mission_filename.json".format(sys.argv[0]))
        sys.exit()

    print("Read mission file"+sys.argv[0])
    mission = json.load(open(sys.argv[1]))
    mission_name = sys.argv[1].split('/')[-1].split('.')[0]
    print('Mission name = ' + mission_name)


    # Get hom_dir and check env variable to build path
    home_dir = ''
    for s in mission["home_dir"].split('/'):
        if s[0]=='$' :            
            home_dir += os.environ[s[1:]]+'/'
        else:
            home_dir += s+'/' 

    # Get map info
    print(home_dir)            
    print("Map  = "+mission["map_data"]["image_file"])
    map_size = mission["map_data"]["map_size"]    
    x_0 = float(map_size['x_min'])
    y_0 = float(map_size['y_max'])
    dx = float(map_size['x_max'])-float(map_size['x_min'])
    dy = float(map_size['y_max'])-float(map_size['y_min'])

    # Read image data
    image = QtGui.QImage(home_dir+mission["map_data"]["image_file"])
    if image.isNull():
        print("Error image not found")
        sys.exit()


        

        
    # Start application and widgets
    app = QtGui.QApplication(sys.argv)
    map_viewer = MapViewer(image, x_0, y_0, dx, dy)
    main_window = MainWin(map_viewer)

    
    # Start ros node
    rospy.init_node('ISMAC')#, anonymous=True)

    ## Analyse and add list of agents
    agents_list = mission['agents']
    for agent, props in agents_list.iteritems():        
        print('Add agent: '+agent+"\t"+props['color'])
        map_viewer.add_agent(Agent(agent, props['color']))
        #map_viewer.add_agent(Agent(agent, agents_list[agent]['color']))
        main_window.add_agent(agent)

    ## Analyse and add list of targets as agents in map_viewer only
    for target, props in mission['targets'].iteritems():        
        print('Add target: '+target+"\t"+props['color'])
        map_viewer.add_agent(Agent(target, props['color']))


    app.exec_()
    
if __name__ == '__main__':
    try:
        main()
    except rospy.ROSInterruptException:
        pass

